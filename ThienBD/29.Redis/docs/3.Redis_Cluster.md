# H∆Ø·ªöNG D·∫™N C√ÄI ƒê·∫∂T REDIS CLUSTER
# 1. M√¥ h√¨nh Redis Cluster
Redis Cluster y√™u c·∫ßu t·ªëi thi·ªÉu `3 node master`, v√† trong tr∆∞·ªùng h·ª£p n√†y, m·ªói node v·ª´a l√† `master`, v·ª´a l√† `slave` c·ªßa node kh√°c.

![alt text](../imgs/1.png)

# 2. C√†i ƒë·∫∑t Redis server

**B∆∞·ªõc 1. C√†i ƒë·∫∑t Redis tr√™n t·∫•t c·∫£ c√°c node**  
1. ƒêƒÉng nh·∫≠p v√†o VM v√† c·∫≠p nh·∫≠t h·ªá th·ªëng:
```
sudo apt update && sudo apt upgrade -y
```
2. C√†i ƒë·∫∑t Redis:
```
sudo apt install redis-server -y
```
3. Ki·ªÉm tra Redis ƒë√£ ho·∫°t ƒë·ªông:
```
sudo systemctl status redis
redis-server --version
```
**C√†i ƒë·∫∑t redis b·∫±ng source**
```
apt update && apt upgrade -y
mkdir -p /opt/setup
cd /opt/setup
wget https://github.com/redis/redis/archive/7.0.8.tar.gz
tar -xvzf 7.0.8.tar.gz
apt install make
apt install make-guile
apt install -y build-essential pkg-config gcc
apt install -y libjemalloc-dev
make distclean
make
make install
```


**B∆∞·ªõc 2. C·∫•u h√¨nh Redis cluster**

1. Tr√™n m·ªói server, t·∫°o th∆∞ m·ª•c ch·ª©a d·ªØ li·ªáu Redis
```
sudo mkdir -p /etc/redis 
sudo mkdir -p /var/redis
```
2. C·∫•u h√¨nh tr√™n t·ª´ng node  
**T·∫°o file c·∫•u h√¨nh Redis ri√™ng cho t·ª´ng server**

üîπ Server 1:   
`C·∫•u h√¨nh Master (7000)`  
T·∫°o file /etc/redis/7000.conf v·ªõi n·ªôi dung: 
```
sudo vi /etc/redis/7000.conf
```
```
port 7000
bind 192.168.74.25
dir /var/redis/7000
cluster-enabled yes
cluster-config-file nodes-7000.conf
cluster-node-timeout 5000
appendonly yes
daemonize yes

```
`C·∫•u h√¨nh Slave (7003)`  
T·∫°o file /etc/redis/7003.conf v·ªõi n·ªôi dung:
```
sudo vi /etc/redis/7003.conf
```
```
port 7003
bind 192.168.74.25
dir /var/redis/7003
cluster-enabled yes
cluster-config-file nodes-7003.conf
cluster-node-timeout 5000
appendonly yes
daemonize yes

```
üîπ Server 2:   
`C·∫•u h√¨nh Master (7001)`   
T·∫°o file /etc/redis/7001.conf v·ªõi n·ªôi dung: 
```
sudo vi /etc/redis/70011.conf
```

```
port 7001
bind 192.168.74.26
dir /var/redis/7001
cluster-enabled yes
cluster-config-file nodes-7001.conf
cluster-node-timeout 5000
appendonly yes
daemonize yes

```
`C·∫•u h√¨nh Slave (7004)`
T·∫°o file /etc/redis/7004.conf v·ªõi n·ªôi dung:   
```
sudo vi /etc/redis/7004.conf
```
```
port 7004
bind 192.168.74.26
dir /var/redis/7004
cluster-enabled yes
cluster-config-file nodes-7004.conf
cluster-node-timeout 5000
appendonly yes
daemonize yes

```
üîπ Server 3:

`C·∫•u h√¨nh Master (7002)`   
T·∫°o file /etc/redis/7002.conf v·ªõi n·ªôi dung: 
```
sudo vi /etc/redis/7002.conf
```

```
port 7002
bind 192.168.74.27
dir /var/redis/7002
cluster-enabled yes
cluster-config-file nodes-7002.conf
cluster-node-timeout 5000
appendonly yes
daemonize yes

```
`C·∫•u h√¨nh Slave (7005)`   
T·∫°o file /etc/redis/7005.conf v·ªõi n·ªôi dung:
```
sudo vi /etc/redis/7005.conf
```
```
port 7005
bind 192.168.74.27
dir /var/redis/7005
cluster-enabled yes
cluster-config-file nodes-7005.conf
cluster-node-timeout 5000
appendonly yes
daemonize yes

```

**B∆∞·ªõc 3: T·∫°o th∆∞ m·ª•c v√† c·∫•p quy·ªÅn cho Redis ƒë·ªçc v√† ghi n·ªôi dung v√†o** 

üîπ Server 1:
- **Cho Master**  
```
sudo mkdir -p /var/redis/7000
sudo chown redis:redis /var/redis/7000
sudo chmod 770 /var/redis/7000
```
- **Cho Slave**  
```
sudo mkdir -p /var/redis/7003
sudo chown redis:redis /var/redis/7003
sudo chmod 770 /var/redis/7003
```
üîπ Server 2:
- **Cho Master**  
```
sudo mkdir -p /var/redis/7001
sudo chown redis:redis /var/redis/7001
sudo chmod 770 /var/redis/7001
```
- **Cho Slave**  
```
sudo mkdir -p /var/redis/7004
sudo chown redis:redis /var/redis/7004
sudo chmod 770 /var/redis/7004
```
üîπ Server 3:
- **Cho Master**  
```
sudo mkdir -p /var/redis/7002
sudo chown redis:redis /var/redis/7002
sudo chmod 770 /var/redis/7002
```
- **Cho Slave**  
```
sudo mkdir -p /var/redis/7005
sudo chown redis:redis /var/redis/7005
sudo chmod 770 /var/redis/7005
```

**B∆∞·ªõc 4: M·ªü C·ªïng Tr√™n Firewall**
Ch·∫°y tr√™n t·∫•t c·∫£ c√°c server:
```
sudo ufw allow 7000:7005/tcp
sudo ufw reload
```

**B∆∞·ªõc 5: Kh·ªüi ƒê·ªông Redis Tr√™n M·ªói Server**

Ch·∫°y tr√™n t·ª´ng server:

üîπ Server 1:
```
redis-server /etc/redis/7000.conf --daemonize yes  
redis-server /etc/redis/7003.conf --daemonize yes  
```
üîπ Server 2:
```
redis-server /etc/redis/7001.conf --daemonize yes  
redis-server /etc/redis/7004.conf --daemonize yes  
```
üîπ Server 3:
```
redis-server /etc/redis/7002.conf --daemonize yes  
redis-server /etc/redis/7005.conf --daemonize yes
```
Ki·ªÉm tra Redis ƒë√£ ch·∫°y ch∆∞a:
```
ps aux | grep redis
```
**B∆∞·ªõc 6: T·∫°o Redis Cluster**

Ch·∫°y tr√™n b·∫•t k·ª≥ server n√†o, v√≠ d·ª• `192.168.74.25`:
```
redis-cli --cluster create \
192.168.74.25:7000 192.168.74.26:7001 192.168.74.27:7002 \
192.168.74.25:7003 192.168.74.26:7004 192.168.74.27:7005 \
--cluster-replicas 1
```
![alt text](../imgs/2.png)
Nh·∫≠p `yes` ƒë·ªÉ x√°c nh·∫≠n.

![alt text](../imgs/3.png)

K·∫øt qu·∫£ tr·∫£ v·ªÅ ta c√≥ `3 Master` v√† `3 Slave` 

**B∆∞·ªõc 7: Ki·ªÉm tra Cluster**  
Ch·∫°y tr√™n b·∫•t k·ª≥ server n√†o, v√≠ d·ª• `192.168.74.25`:
```
redis-cli -c -h 192.168.74.25 -p 7000 cluster nodes
```
![alt text](../imgs/4.png)

# 3. C·∫•u H√¨nh Redis Cluster Cho Nextcloud

**B∆∞·ªõc 1: C·∫•u h√¨nh file config**  
M·ªü file c·∫•u h√¨nh Nextcloud (config.php):

```
sudo vi /var/www/html/nextcloud/config/config.php
```
```
'memcache.local' => '\\OC\\Memcache\\Redis',
  'memcache.distributed' => '\\OC\\Memcache\\Redis',
  'memcache.locking' => '\\OC\\Memcache\\Redis',
  'redis.cluster' => [
      'seeds' => [ // provide some/all of the cluster servers to bootstrap discovery, port required
          '192.168.74.25:7000',
          '192.168.74.26:7001',
          '192.168.74.27:7002',
          '192.168.74.25:7003',
          '192.168.74.26:7004',
          '192.168.74.27:7005',
  ],
  'timeout' => 0.0,
  'read_timeout' => 0.0,
  'failover_mode' => \RedisCluster::FAILOVER_ERROR
  ],

```
**B∆∞·ªõc 2: Restart l·∫°i d·ªãch v·ª•** 

```
sudo systemctl restart apache2
```
**B∆∞·ªõc 3: Ki·ªÉm Tra K·∫øt N·ªëi Redis**
```
redis-cli -c -h 192.168.74.25 -p 7000 ping
redis-cli -c -h 192.168.74.26 -p 7001 ping
redis-cli -c -h 192.168.74.27 -p 7002 ping
```
N·∫øu tr·∫£ v·ªÅ `PONG`, Redis ƒëang ho·∫°t ƒë·ªông t·ªët.
# 4. Ki·ªÉm Tra Redis C√≥ Nh·∫≠n L·ªánh T·ª´ Nextcloud Kh√¥ng
Tr√™n server Nextcloud, ch·∫°y l·ªánh:
```
redis-cli -c -h 192.168.74.25 -p 7000 monitor
```
B√¢y gi·ªù m·ªü Nextcloud tr√™n tr√¨nh duy·ªát, thao t√°c v√†i trang, r·ªìi quay l·∫°i terminal. N·∫øu th·∫•y c√°c l·ªánh `GET/SET` xu·∫•t hi·ªán, Nextcloud ƒëang s·ª≠ d·ª•ng Redis.

![alt text](../imgs/5.png)